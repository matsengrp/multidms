
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Simulation validation &#8212; multidms 1.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="multidms usage examples" href="fit_delta_BA1_example.html" />
    <link rel="prev" title="Biophysical model" href="biophysical_model.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="Simulation-validation">
<h1>Simulation validation<a class="headerlink" href="#Simulation-validation" title="Permalink to this heading">¶</a></h1>
<section id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this heading">¶</a></h2>
<p>The bloom lab had developed a <a class="reference external" href="https://jbloomlab.github.io/dms_variants/codonvariant_sim_data.html">pipeline to simulate DMS data</a> to test <code class="docutils literal notranslate"><span class="pre">dms_variants</span></code> global epistasis fitting. Taking inspriation from that, we build upon the pipeline by simulating data for <em>two</em> homologs - introducing shifts in mutational effects at a subset of sites with the goal validating the <code class="docutils literal notranslate"><span class="pre">multidms</span></code> joint-fitting approach.</p>
<p>This notebook has a few major steps involved:</p>
<ol class="arabic simple">
<li><p>Simulate sequences, and respective mutational effects for two homologs – introducing <em>shifts</em> at a subset of sites for the non-reference homolog.</p></li>
<li><p>Define replicate libraries of variants for each homolog.</p></li>
<li><p>Simulating pre, and post-selection library variant <em>counts</em> derived from a simulated bottleneck and used to introduce realistic noise in the fitting targets (functional scores).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multidms</span></code> model fitting.</p></li>
<li><p>Model fit comparison and selection criteria</p></li>
<li><p>Model evaluation.</p></li>
</ol>
</section>
<section id="Import-Python-modules">
<h2>Import <code class="docutils literal notranslate"><span class="pre">Python</span></code> modules<a class="headerlink" href="#Import-Python-modules" title="Permalink to this heading">¶</a></h2>
<p>For this analysis, we’ll be using the <code class="docutils literal notranslate"><span class="pre">dms_variants</span></code> package for simulation. All dependencies needed can be installed by cloning the <code class="docutils literal notranslate"><span class="pre">multidms</span></code> repo and executing the command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ pip install &#39;.[dev]&#39;
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[176]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">Bio.Seq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dms_variants.codonvarianttable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dms_variants.globalepistasis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dms_variants.plotnine_themes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dms_variants.simulate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dms_variants.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">CBPALETTE</span><span class="p">,</span> <span class="n">CODONS_NOSTOP</span><span class="p">,</span> <span class="n">AAS_NOSTOP</span><span class="p">,</span> <span class="n">AA_TO_CODONS</span><span class="p">,</span> <span class="n">AAS_WITHSTOP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotnine</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multidms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multidms.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">split_sub</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-notebook-parameters">
<h2>Define notebook parameters<a class="headerlink" href="#Define-notebook-parameters" title="Permalink to this heading">¶</a></h2>
<p>Set parameters that define this notebook’s behavior. These can all be modifed (using <code class="docutils literal notranslate"><span class="pre">papermill</span></code>) to reasonable values and the notebook should execute as expected.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[177]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># random number seed</span>

<span class="c1"># define the reference protein sequence we&#39;re going to simulate</span>
<span class="n">genelength</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># gene length in codons</span>
<span class="n">wt_latent</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c1"># wildtype latent phenotype</span>
<span class="n">stop_effect</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="c1"># -15 is the default for `SigmoidPhenotypeSimulator` object</span>
<span class="n">norm_weights</span><span class="o">=</span><span class="p">((</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">.33</span><span class="p">,</span> <span class="mf">.8</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.666</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="c1"># See `SigmoidPhenotypeSimulator` for more details</span>

<span class="c1"># define the non reference sequence attributes.</span>
<span class="n">n_non_identical_sites</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># number of amino-acid mutations separating homologs</span>
<span class="n">min_muteffect_in_bundle</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># minimum effect per mutation</span>
<span class="n">max_muteffect_in_bundle</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># maximum effect per mutation</span>
<span class="n">n_shifted_non_identical_sites</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># number of non identical sites (in the bundle) for which mutations at that site are expected to have shifted effects</span>
<span class="n">n_shifted_identical_sites</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># number of amino-acid mutations separating shifted</span>
<span class="n">shift_gauss_variance</span> <span class="o">=</span> <span class="mf">0.666</span> <span class="c1"># variance of the gaussian distribution from which the shifted effects are drawn</span>

<span class="c1"># define the sigmoid phenotype parameters. See `multidms.biophysical.sigmoidal_global_epistasis` for more details.</span>
<span class="n">sigmoid_phenotype_scale</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># define the libraries</span>
<span class="n">variants_per_lib_genelength_scalar</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># variants per library</span>
<span class="n">avgmuts</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># average codon mutations per variant</span>
<span class="n">bclen</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># length of nucleotide barcode for each variant</span>
<span class="n">variant_error_rate</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#0.005  # rate at which variant sequence mis-called</span>
<span class="n">avgdepth_per_variant</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># average per-variant sequencing depth</span>
<span class="n">lib_uniformity</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># uniformity of library pre-selection</span>
<span class="n">noise</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># 0.05 # random gaussian noise added to the post-selection counts of the phenotype</span>

<span class="c1"># bottlenecks from pre- to post-selection</span>
<span class="n">bottleneck_variants_per_lib_scalar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tight_bottle&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;loose_bottle&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># define the fitting parameters</span>
<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">100000</span> <span class="c1"># default 20000</span>
<span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">coef_lasso_shift</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.00e-6</span><span class="p">,</span> <span class="mf">1.00e-05</span><span class="p">,</span> <span class="mf">2.00e-05</span><span class="p">,</span> <span class="mf">4.00e-05</span><span class="p">,</span> <span class="mf">8.00e-05</span><span class="p">,</span> <span class="mf">1.60e-04</span><span class="p">,</span> <span class="mf">3.20e-04</span><span class="p">,</span> <span class="mf">6.40e-04</span><span class="p">]</span> <span class="c1"># the sweep of lasso coefficient params</span>
<span class="n">init_beta0</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c1"># We&#39;ve found that we need to start with a higher beta0 to get the model to converge correctly,</span>
<span class="n">coef_ridge_beta</span> <span class="o">=</span> <span class="mf">1e-7</span> <span class="c1"># the sweep of ridge coefficient params</span>
<span class="n">train_frac</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># fraction of data to use for cross validation training.</span>
<span class="n">lasso_choice</span> <span class="o">=</span> <span class="mf">8e-5</span> <span class="c1"># the lasso coefficient to use for the final model</span>
<span class="n">csv_output_dir</span> <span class="o">=</span> <span class="s1">&#39;scaled_down_parameter_output&#39;</span> <span class="c1"># the directory to save the output csv files</span>
</pre></div>
</div>
</div>
<p>Set some configurations and a few other more experimental parameters which could break things if not set correctly:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[178]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_output_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">csv_output_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Simulate-a-reference-sequence">
<h2>Simulate a reference sequence<a class="headerlink" href="#Simulate-a-reference-sequence" title="Permalink to this heading">¶</a></h2>
<p>Start by simulating a sequence of nucleotides, then translate it to amino acids. We’ll use this sequence as the reference sequence for the simulated datasets.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[179]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geneseq_h1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">CODONS_NOSTOP</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">genelength</span><span class="p">))</span>
<span class="n">aaseq_h1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Bio</span><span class="o">.</span><span class="n">Seq</span><span class="o">.</span><span class="n">Seq</span><span class="p">(</span><span class="n">geneseq_h1</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wildtype gene of </span><span class="si">{</span><span class="n">genelength</span><span class="si">}</span><span class="s2"> codons:</span><span class="se">\n</span><span class="si">{</span><span class="n">geneseq_h1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wildtype protein:</span><span class="se">\n</span><span class="si">{</span><span class="n">aaseq_h1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Wildtype gene of 50 codons:
TTCTTAAATACCTCAGTAGGACAGGCAGCCGATAGCCGGCGAGTATTTTTAGACCGTCAAAAGAACCTACATCCTTGCGAAGAGATGAACCATAGACTTTTTGGCAGTTGCTACGTATGGGTGTACCCCTTGTTCAGCGTCGGTCTAGAA
Wildtype protein:
FLNTSVGQAADSRRVFLDRQKNLHPCEEMNHRLFGSCYVWVYPLFSVGLE
</pre></div></div>
</div>
</section>
<section id="Mutational-effects">
<h2>Mutational effects<a class="headerlink" href="#Mutational-effects" title="Permalink to this heading">¶</a></h2>
<p>Simulate latent mutational effects, <span class="math notranslate nohighlight">\(\beta_m\)</span>, storing data in a <code class="docutils literal notranslate"><span class="pre">SigmoidPhenotypeSimulator</span></code> object. Also create an identical object for the second homolog. Later, we’ll update this object to include shifted mutational effects.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[180]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mut_pheno_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;geneseq&quot;</span> <span class="p">:</span> <span class="n">geneseq_h1</span><span class="p">,</span>
    <span class="s2">&quot;wt_latent&quot;</span> <span class="p">:</span> <span class="n">wt_latent</span><span class="p">,</span>
    <span class="s2">&quot;seed&quot;</span> <span class="p">:</span> <span class="n">seed</span><span class="p">,</span>
    <span class="s2">&quot;stop_effect&quot;</span> <span class="p">:</span> <span class="n">stop_effect</span><span class="p">,</span>
    <span class="s2">&quot;norm_weights&quot;</span> <span class="p">:</span> <span class="n">norm_weights</span>
<span class="p">}</span>

<span class="n">SigmoidPhenotype_h1</span> <span class="o">=</span> <span class="n">dms_variants</span><span class="o">.</span><span class="n">simulate</span><span class="o">.</span><span class="n">SigmoidPhenotypeSimulator</span><span class="p">(</span><span class="o">**</span><span class="n">mut_pheno_args</span><span class="p">)</span>
<span class="n">SigmoidPhenotype_h2</span> <span class="o">=</span> <span class="n">dms_variants</span><span class="o">.</span><span class="n">simulate</span><span class="o">.</span><span class="n">SigmoidPhenotypeSimulator</span><span class="p">(</span><span class="o">**</span><span class="n">mut_pheno_args</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Plot the distribution of mutation effects for the first homolog.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[181]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;muteffects&#39;</span><span class="p">:</span> <span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">muteffects</span><span class="p">}),</span>
           <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;muteffects&#39;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;mutation effect, $β$&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s1">&#39;number of mutations&#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_18_0.png" src="_images/simulation_validation_18_0.png" />
</div>
</div>
<p>As expected, our mutational effects are weighted in the negative direction, as we expect the majority of mutations to be deleterious to a protein.</p>
</section>
<section id="Non-reference-homolog-sequence">
<h2>Non-reference homolog sequence<a class="headerlink" href="#Non-reference-homolog-sequence" title="Permalink to this heading">¶</a></h2>
<p>Next, we’ll simulate the DNA/protein sequence of second homolog by making a defined number of random amino-acid mutations to the first homolog. When choosing the “bundle” of mutation which separate the two homologs, we avoid mutations that decrease or increase the latent phenotype by more than <code class="docutils literal notranslate"><span class="pre">min_muteffect_in_bundle</span></code> and <code class="docutils literal notranslate"><span class="pre">max_muteffect_in_bundle</span></code> respectively. This is to ensure that the latent phenotype of the second homolog is not too different from the first homolog, an important
assumption for the <code class="docutils literal notranslate"><span class="pre">multidms</span></code> model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[182]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input params</span>
<span class="n">non_identical_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aaseq_h1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">n_non_identical_sites</span><span class="p">))</span>
<span class="n">aaseq_h2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">geneseq_h2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>


<span class="c1"># Iterate over each amino acid in the first homolog, and make a mutation if indicated.</span>
<span class="k">for</span> <span class="p">(</span><span class="n">aa_n</span><span class="p">,</span> <span class="n">aa</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aaseq_h1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">codon</span> <span class="o">=</span> <span class="n">geneseq_h1</span><span class="p">[(</span><span class="n">aa_n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">aa_n</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">aa_n</span> <span class="ow">in</span> <span class="n">non_identical_sites</span><span class="p">:</span>
        <span class="c1"># define the valid mutations for this site</span>
        <span class="n">valid_bundle_mutations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mut_aa</span> <span class="k">for</span> <span class="n">mut_aa</span> <span class="ow">in</span> <span class="n">AAS_NOSTOP</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">mut_aa</span> <span class="o">!=</span> <span class="n">aa</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">muteffects</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">aa</span><span class="si">}{</span><span class="n">aa_n</span><span class="si">}{</span><span class="n">mut_aa</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_muteffect_in_bundle</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">muteffects</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">aa</span><span class="si">}{</span><span class="n">aa_n</span><span class="si">}{</span><span class="n">mut_aa</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_muteffect_in_bundle</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_bundle_mutations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aa_n</span>
        <span class="n">mut_aa</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_bundle_mutations</span><span class="p">)</span>
        <span class="n">aaseq_h2</span> <span class="o">+=</span> <span class="n">mut_aa</span>
        <span class="n">mut_codon</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">AA_TO_CODONS</span><span class="p">[</span><span class="n">mut_aa</span><span class="p">])</span>
        <span class="n">geneseq_h2</span> <span class="o">+=</span> <span class="n">mut_codon</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aaseq_h2</span> <span class="o">+=</span> <span class="n">aa</span>
        <span class="n">geneseq_h2</span> <span class="o">+=</span> <span class="n">codon</span>

<span class="c1"># Store and summarize results</span>
<span class="n">homolog_seqs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;wt_aa_h1&quot;</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">aaseq_h1</span><span class="p">),</span> <span class="s2">&quot;wt_aa_h2&quot;</span> <span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">aaseq_h2</span><span class="p">)},</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aaseq_h1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">homolog_seqs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;site&#39;</span>

<span class="c1"># n_diffs = sum([aa1 != aa2 for (aa1, aa2) in zip(*homolog_seqs.values())])</span>
<span class="n">n_diffs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">homolog_seqs_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;wt_aa_h1 != wt_aa_h2&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sequence alignment of homologs h1 and h2:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="n">aaseq_h1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">,</span> <span class="n">aaseq_h2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of aa differences:&#39;</span><span class="p">,</span> <span class="n">n_diffs</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aaseq_h1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aaseq_h2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">aaseq_h2</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">Bio</span><span class="o">.</span><span class="n">Seq</span><span class="o">.</span><span class="n">Seq</span><span class="p">(</span><span class="n">geneseq_h2</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">n_diffs</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_identical_sites</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sequence alignment of homologs h1 and h2:
h1 FLNTSVGQAADSRRVFLDRQKNLHPCEEMNHRLFGSCYVWVYPLFSVGLE
h2 FLNTMVGWDADTRRVFLDFAKNLHPVEEMNCRLFGSCYVWVVPLFSYGLE
Number of aa differences: 10
</pre></div></div>
</div>
</section>
<section id="Shifted-mutational-effects">
<h2>Shifted mutational effects<a class="headerlink" href="#Shifted-mutational-effects" title="Permalink to this heading">¶</a></h2>
<p>Next, randomly choose a subset of (identical and non-identical) sites that will have shifted mutational effects. Do this independently for sites that are identical and non-identical between homologs, so that we are sure to have shifted sites in each category.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[183]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-identical sites</span>
<span class="n">shifted_non_identical_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="n">non_identical_sites</span><span class="p">,</span>
    <span class="n">n_shifted_non_identical_sites</span>
<span class="p">))</span>

<span class="c1"># choose a subset of the identical sites to have shifted effects</span>
<span class="n">shifted_identical_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aaseq_h1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">non_identical_sites</span><span class="p">)),</span>
    <span class="n">n_shifted_identical_sites</span>
<span class="p">))</span>

<span class="c1"># Make a list of all shifted sites</span>
<span class="n">shifted_sites</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shifted_identical_sites</span> <span class="o">+</span> <span class="n">shifted_non_identical_sites</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifted_sites</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">shifted_sites</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sites with shifts that are...&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;identical (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shifted_identical_sites</span><span class="p">)</span><span class="si">}</span><span class="s1">):&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">shifted_identical_sites</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;non-identical (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">shifted_non_identical_sites</span><span class="p">)</span><span class="si">}</span><span class="s1">):&#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">shifted_non_identical_sites</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sites with shifts that are...
identical (n=4): 6, 14, 25, 39
non-identical (n=6): 8, 9, 12, 19, 31, 47
</pre></div></div>
</div>
<p>Next, we’ll create a dataframe for all mutational effects and shifts, simulating shifts at each of the above sites by randomly simulate a shift in the effect of each mutation by drawing shifts from a Gaussian distribution:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sim_mut_shift</span><span class="p">(</span><span class="n">shifted_site</span><span class="p">,</span> <span class="n">mutation</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">shifted_site</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">mutation</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">shift_gauss_variance</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Make a dataframe of mutation effects in the first homolog</span>
<span class="n">mut_effects_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">muteffects</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beta_h1&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;mutation&#39;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">wt_aa</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">split_sub</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">split_sub</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span>
        <span class="n">mut_aa</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">split_sub</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">shifted_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shifted_sites</span><span class="p">),</span>
        <span class="n">shift</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">sim_mut_shift</span><span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;shifted_site&#39;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">),</span>
        <span class="n">beta_h2</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;beta_h1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">homolog_seqs_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">bundle_mut</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;mut_aa&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wt_aa_h2&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Show data for a subset of sites with shifts</span>
<span class="n">mut_effects_df</span><span class="p">[</span><span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;shifted_site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">][[</span>
    <span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;wt_aa_h1&#39;</span><span class="p">,</span> <span class="s1">&#39;wt_aa_h2&#39;</span><span class="p">,</span> <span class="s1">&#39;mutation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;beta_h1&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_h2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;shifted_site&#39;</span>
<span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site</th>
      <th>wt_aa_h1</th>
      <th>wt_aa_h2</th>
      <th>mutation</th>
      <th>beta_h1</th>
      <th>shift</th>
      <th>beta_h2</th>
      <th>shifted_site</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>100</th>
      <td>6</td>
      <td>V</td>
      <td>V</td>
      <td>V6A</td>
      <td>-0.406196</td>
      <td>-0.277561</td>
      <td>-0.683757</td>
      <td>True</td>
    </tr>
    <tr>
      <th>101</th>
      <td>6</td>
      <td>V</td>
      <td>V</td>
      <td>V6C</td>
      <td>-3.915089</td>
      <td>-0.037474</td>
      <td>-3.952563</td>
      <td>True</td>
    </tr>
    <tr>
      <th>102</th>
      <td>6</td>
      <td>V</td>
      <td>V</td>
      <td>V6D</td>
      <td>-0.409342</td>
      <td>-1.422707</td>
      <td>-1.832049</td>
      <td>True</td>
    </tr>
    <tr>
      <th>103</th>
      <td>6</td>
      <td>V</td>
      <td>V</td>
      <td>V6E</td>
      <td>-4.280136</td>
      <td>1.092420</td>
      <td>-3.187716</td>
      <td>True</td>
    </tr>
    <tr>
      <th>104</th>
      <td>6</td>
      <td>V</td>
      <td>V</td>
      <td>V6F</td>
      <td>-0.862349</td>
      <td>-1.194428</td>
      <td>-2.056777</td>
      <td>True</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>935</th>
      <td>47</td>
      <td>V</td>
      <td>Y</td>
      <td>V47S</td>
      <td>-0.027698</td>
      <td>-0.967941</td>
      <td>-0.995638</td>
      <td>True</td>
    </tr>
    <tr>
      <th>936</th>
      <td>47</td>
      <td>V</td>
      <td>Y</td>
      <td>V47T</td>
      <td>-2.240557</td>
      <td>-0.225120</td>
      <td>-2.465677</td>
      <td>True</td>
    </tr>
    <tr>
      <th>937</th>
      <td>47</td>
      <td>V</td>
      <td>Y</td>
      <td>V47W</td>
      <td>-0.178289</td>
      <td>0.239183</td>
      <td>0.060894</td>
      <td>True</td>
    </tr>
    <tr>
      <th>938</th>
      <td>47</td>
      <td>V</td>
      <td>Y</td>
      <td>V47Y</td>
      <td>-0.491120</td>
      <td>0.414399</td>
      <td>-0.076721</td>
      <td>True</td>
    </tr>
    <tr>
      <th>939</th>
      <td>47</td>
      <td>V</td>
      <td>Y</td>
      <td>V47*</td>
      <td>-10.000000</td>
      <td>0.000000</td>
      <td>-10.000000</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>200 rows × 8 columns</p>
</div></div>
</div>
<p>Plot the distribution of all simulated shifts, excluding mutations to stop codons and sites that have no shifted effects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[185]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_stop_shifted_muts</span> <span class="o">=</span> <span class="n">mut_effects_df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shifted_sites</span><span class="p">))</span> <span class="o">&amp;</span>
    <span class="o">~</span><span class="p">(</span><span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;\*&#39;</span><span class="p">))</span>
<span class="p">]</span>

<span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">non_stop_shifted_muts</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;shift&#39;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;shift&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s1">&#39;number of mutations&#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_29_0.png" src="_images/simulation_validation_29_0.png" />
</div>
</div>
<p>We can also plot the shifts as a heatmap, and mark the wildtype amino acid at each site (<code class="docutils literal notranslate"><span class="pre">x</span></code> for reference, <code class="docutils literal notranslate"><span class="pre">o</span></code> for non-reference):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[186]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_abs_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">x_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">homolog_seqs_df</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">y_scale</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
    <span class="s2">&quot;R&quot;</span><span class="p">,</span><span class="s2">&quot;K&quot;</span><span class="p">,</span><span class="s2">&quot;H&quot;</span><span class="p">,</span><span class="s2">&quot;D&quot;</span><span class="p">,</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span><span class="s2">&quot;N&quot;</span><span class="p">,</span><span class="s2">&quot;S&quot;</span><span class="p">,</span>
    <span class="s2">&quot;T&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="s2">&quot;F&quot;</span><span class="p">,</span><span class="s2">&quot;A&quot;</span><span class="p">,</span><span class="s2">&quot;I&quot;</span><span class="p">,</span><span class="s2">&quot;L&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span>
    <span class="s2">&quot;V&quot;</span><span class="p">,</span><span class="s2">&quot;G&quot;</span><span class="p">,</span><span class="s2">&quot;P&quot;</span><span class="p">,</span><span class="s2">&quot;C&quot;</span><span class="p">,</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
<span class="p">])</span>

<span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mut_effects_df</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_tile</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;factor(site)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;mut_aa&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">.9</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
        <span class="n">homolog_seqs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;factor(site)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;wt_aa_h1&#39;</span> <span class="c1">#, label=&#39;aaseq_h1&#39;</span>
        <span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;x&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
        <span class="n">homolog_seqs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;wt_aa_h1 != wt_aa_h2&#39;</span><span class="p">),</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;factor(site)&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;wt_aa_h2&#39;</span>
        <span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;o&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">x_scale</span><span class="p">,</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">x_scale</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_y_discrete</span><span class="p">(</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">y_scale</span><span class="p">,</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">y_scale</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_fill_gradientn</span><span class="p">(</span>
        <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">],</span>
        <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">max_abs_value</span><span class="p">,</span> <span class="n">max_abs_value</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s1">&#39;mutation&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_31_0.png" src="_images/simulation_validation_31_0.png" />
</div>
</div>
<p>Recal that we have already created a <code class="docutils literal notranslate"><span class="pre">SigmoidPhenotypeSimulator</span></code> object for the second homolog by making a copy of the one for the first homolog. This object stores the homolog’s wildtype latent phenotype and the latent effects of individual mutations. Below, we update both of these traits based on the simulated shifts from above. To update the wildtype latent phenotype of the second homolog, we add the effects of all mutations that separate the homologs. In computing this sum, we will use
<span class="math notranslate nohighlight">\(\beta\)</span> parameters for the second homolog, which already include shifted effects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[187]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update individual mutational effects</span>
<span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">mutation</span> <span class="ow">in</span> <span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">muteffects</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">muteffects</span><span class="p">[</span><span class="n">mutation</span><span class="p">]</span> <span class="o">=</span> <span class="n">mut_effects_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">mutation</span><span class="p">,</span> <span class="s1">&#39;beta_h2&#39;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">wt_latent_phenotype_shift</span> <span class="o">=</span> <span class="n">mut_effects_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;bundle_mut&quot;</span><span class="p">)[</span><span class="s2">&quot;beta_h2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span> <span class="o">=</span> <span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">wt_latent</span> <span class="o">+</span> <span class="n">wt_latent_phenotype_shift</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Characteristics of mutations separating homologs:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;beta_h1&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_h2&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Sum of </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mut_effects_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;bundle_mut&quot;</span><span class="p">)[</span><span class="n">metric</span><span class="p">]),</span> <span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Final WT latent phenotype of h2:&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Table of mutations that separate homologs:&#39;</span><span class="p">)</span>
<span class="n">mut_effects_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;mut_aa == wt_aa_h2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Characteristics of mutations separating homologs:

  Sum of beta_h1: -0.76
  Sum of shift: -0.83
  Sum of beta_h2: -1.59
  Final WT latent phenotype of h2: 3.41
  Table of mutations that separate homologs:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[187]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mutation</th>
      <th>beta_h1</th>
      <th>wt_aa</th>
      <th>site</th>
      <th>mut_aa</th>
      <th>shifted_site</th>
      <th>shift</th>
      <th>beta_h2</th>
      <th>wt_aa_h1</th>
      <th>wt_aa_h2</th>
      <th>bundle_mut</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>90</th>
      <td>S5M</td>
      <td>-0.209250</td>
      <td>S</td>
      <td>5</td>
      <td>M</td>
      <td>False</td>
      <td>0.000000</td>
      <td>-0.209250</td>
      <td>S</td>
      <td>M</td>
      <td>True</td>
    </tr>
    <tr>
      <th>157</th>
      <td>Q8W</td>
      <td>0.216508</td>
      <td>Q</td>
      <td>8</td>
      <td>W</td>
      <td>True</td>
      <td>0.334237</td>
      <td>0.550745</td>
      <td>Q</td>
      <td>W</td>
      <td>True</td>
    </tr>
    <tr>
      <th>161</th>
      <td>A9D</td>
      <td>0.226606</td>
      <td>A</td>
      <td>9</td>
      <td>D</td>
      <td>True</td>
      <td>0.361207</td>
      <td>0.587813</td>
      <td>A</td>
      <td>D</td>
      <td>True</td>
    </tr>
    <tr>
      <th>235</th>
      <td>S12T</td>
      <td>0.586065</td>
      <td>S</td>
      <td>12</td>
      <td>T</td>
      <td>True</td>
      <td>-0.254090</td>
      <td>0.331975</td>
      <td>S</td>
      <td>T</td>
      <td>True</td>
    </tr>
    <tr>
      <th>364</th>
      <td>R19F</td>
      <td>-0.550723</td>
      <td>R</td>
      <td>19</td>
      <td>F</td>
      <td>True</td>
      <td>-1.560840</td>
      <td>-2.111563</td>
      <td>R</td>
      <td>F</td>
      <td>True</td>
    </tr>
    <tr>
      <th>380</th>
      <td>Q20A</td>
      <td>-0.188525</td>
      <td>Q</td>
      <td>20</td>
      <td>A</td>
      <td>False</td>
      <td>0.000000</td>
      <td>-0.188525</td>
      <td>Q</td>
      <td>A</td>
      <td>True</td>
    </tr>
    <tr>
      <th>516</th>
      <td>C26V</td>
      <td>-0.115867</td>
      <td>C</td>
      <td>26</td>
      <td>V</td>
      <td>False</td>
      <td>0.000000</td>
      <td>-0.115867</td>
      <td>C</td>
      <td>V</td>
      <td>True</td>
    </tr>
    <tr>
      <th>601</th>
      <td>H31C</td>
      <td>-0.628807</td>
      <td>H</td>
      <td>31</td>
      <td>C</td>
      <td>True</td>
      <td>-0.122049</td>
      <td>-0.750856</td>
      <td>H</td>
      <td>C</td>
      <td>True</td>
    </tr>
    <tr>
      <th>837</th>
      <td>Y42V</td>
      <td>0.393497</td>
      <td>Y</td>
      <td>42</td>
      <td>V</td>
      <td>False</td>
      <td>0.000000</td>
      <td>0.393497</td>
      <td>Y</td>
      <td>V</td>
      <td>True</td>
    </tr>
    <tr>
      <th>938</th>
      <td>V47Y</td>
      <td>-0.491120</td>
      <td>V</td>
      <td>47</td>
      <td>Y</td>
      <td>True</td>
      <td>0.414399</td>
      <td>-0.076721</td>
      <td>V</td>
      <td>Y</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>At this point, all mutations in the second homolog’s <code class="docutils literal notranslate"><span class="pre">SigmoidPhenotypeSimulator</span></code> object are defined relative to the wildtype sequence of the first homolog, which we will call the “reference” homolog. However, to compute phenotypes for the second homolog, we still need to assign the effects of mutations at non-identical sites in the “non-reference” homolog. For instance, if the wildtype amino acid at site 30 is an A in the reference homolog, but is a Y in a non-reference homolog, then the
effect of a Y30G is absent from the second homolog’s simulator object.</p>
<p>To add these missing entries, we will use a strategy that assumes additivity between mutations at the same site. For instance, in the above example, the effect of a Y30G mutation is defined as the sum of the A30Y (negated) and A30G effects in the reference homolog. This approach assumes that mutational effects can be negated, such that A30Y has the opposite effect as Y30A. It also assumes that mutational effects are additive, such that the effect of Y30G is the sum of the effects of Y30A and
A30G.</p>
<p>The below expression defines this approach more explicitly for an arbitrary site. It uses the notation <span class="math notranslate nohighlight">\(\beta_{x,n,z}\)</span> where <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(z\)</span> are amino acids. For a site <span class="math notranslate nohighlight">\(n\)</span>, if <span class="math notranslate nohighlight">\(aa_{\text{wt}}\)</span> is the site’s wildtype amino acid in a non-reference homolog, <span class="math notranslate nohighlight">\(aa_{\text{mut}}\)</span> is a mutant amino acid in a variant of that homolog, and <span class="math notranslate nohighlight">\(aa_{\text{ref}}\)</span> is the site’s wildtype amino acid in the reference homolog, then the mutation’s effect is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\beta_{aa_{\text{wt}},n,aa_{\text{mut}}} = \begin{cases}
      \beta_{aa_{\text{ref}},n,aa_{\text{mut}}} &amp; \text{if } aa_{\text{wt}} = aa_{\text{ref}}\\
      -\beta_{aa_{\text{ref}},n,aa_{\text{wt}}} &amp; \text{if } aa_{\text{mut}} = aa_{\text{ref}}\\
      - \beta_{aa_{\text{ref}},n,aa_{\text{wt}}} +\beta_{aa_{\text{ref}},n,aa_{\text{mut}}} &amp; \text{otherwise}\\
\end{cases}\end{split}\]</div>
<p>The above <span class="math notranslate nohighlight">\(\beta\)</span> parameters are effects in the background of the non-reference homolog, such that they account for shifts in mutational effects between homologs.</p>
<p>The below cell adds mutational effects for missing entries using the above strategy:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[188]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># iterate over &quot;bundle&quot; of mutations which disguish the homologs</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mut_effects_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;mut_aa == wt_aa_h2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

    <span class="c1"># compute the effect of each possible mutation at a bundle site</span>
    <span class="k">for</span> <span class="n">aa_mut</span> <span class="ow">in</span> <span class="n">AAS_WITHSTOP</span><span class="p">:</span>

        <span class="c1"># skip the non-ref wt-to-wt</span>
        <span class="k">if</span> <span class="n">aa_mut</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">wt_aa_h2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">non_ref_mutation</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">wt_aa_h2</span><span class="si">}{</span><span class="n">row</span><span class="o">.</span><span class="n">site</span><span class="si">}{</span><span class="n">aa_mut</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># stop effect is the same for all homologs</span>
        <span class="k">if</span> <span class="n">aa_mut</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">muteffects</span><span class="p">[</span><span class="n">non_ref_mutation</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_effect</span>

        <span class="c1"># back-mutation to reference</span>
        <span class="k">elif</span> <span class="n">aa_mut</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">wt_aa_h1</span><span class="p">:</span>
            <span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">muteffects</span><span class="p">[</span><span class="n">non_ref_mutation</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">beta_h2</span>

        <span class="c1"># all other mutations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_mut</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">wt_aa_h1</span><span class="si">}{</span><span class="n">row</span><span class="o">.</span><span class="n">site</span><span class="si">}{</span><span class="n">aa_mut</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">ref_mut_effect</span> <span class="o">=</span> <span class="n">mut_effects_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">mut_effects_df</span><span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_mut</span><span class="p">,</span> <span class="s1">&#39;beta_h2&#39;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">muteffects</span><span class="p">[</span><span class="n">non_ref_mutation</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">beta_h2</span> <span class="o">+</span> <span class="n">ref_mut_effect</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[189]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mut_effects_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/simulated_muteffects.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mut_effects_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[189]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mutation</th>
      <th>beta_h1</th>
      <th>wt_aa</th>
      <th>site</th>
      <th>mut_aa</th>
      <th>shifted_site</th>
      <th>shift</th>
      <th>beta_h2</th>
      <th>wt_aa_h1</th>
      <th>wt_aa_h2</th>
      <th>bundle_mut</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>F1A</td>
      <td>-2.019912</td>
      <td>F</td>
      <td>1</td>
      <td>A</td>
      <td>False</td>
      <td>0.0</td>
      <td>-2.019912</td>
      <td>F</td>
      <td>F</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>F1C</td>
      <td>-0.417888</td>
      <td>F</td>
      <td>1</td>
      <td>C</td>
      <td>False</td>
      <td>0.0</td>
      <td>-0.417888</td>
      <td>F</td>
      <td>F</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>F1D</td>
      <td>-2.928096</td>
      <td>F</td>
      <td>1</td>
      <td>D</td>
      <td>False</td>
      <td>0.0</td>
      <td>-2.928096</td>
      <td>F</td>
      <td>F</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F1E</td>
      <td>-1.516192</td>
      <td>F</td>
      <td>1</td>
      <td>E</td>
      <td>False</td>
      <td>0.0</td>
      <td>-1.516192</td>
      <td>F</td>
      <td>F</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>F1G</td>
      <td>-4.732575</td>
      <td>F</td>
      <td>1</td>
      <td>G</td>
      <td>False</td>
      <td>0.0</td>
      <td>-4.732575</td>
      <td>F</td>
      <td>F</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Variant-libraries">
<h2>Variant libraries<a class="headerlink" href="#Variant-libraries" title="Permalink to this heading">¶</a></h2>
<p>Simulate a set of variant libraries that one might use in an actual experiment for each homolog, each with two replicate libraries.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[190]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">libs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lib_1&quot;</span><span class="p">,</span> <span class="s2">&quot;lib_2&quot;</span><span class="p">]</span>  <span class="c1"># distinct libraries of gene</span>
<span class="n">variants_per_lib</span> <span class="o">=</span> <span class="n">variants_per_lib_genelength_scalar</span> <span class="o">*</span> <span class="n">genelength</span>

<span class="n">CodonVariantTable_h1</span> <span class="o">=</span> <span class="n">dms_variants</span><span class="o">.</span><span class="n">simulate</span><span class="o">.</span><span class="n">simulate_CodonVariantTable</span><span class="p">(</span>
    <span class="n">geneseq</span><span class="o">=</span><span class="n">geneseq_h1</span><span class="p">,</span>
    <span class="n">bclen</span><span class="o">=</span><span class="n">bclen</span><span class="p">,</span>
    <span class="n">library_specs</span><span class="o">=</span><span class="p">{</span>
        <span class="n">lib</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;avgmuts&quot;</span><span class="p">:</span> <span class="n">avgmuts</span><span class="p">,</span> <span class="s2">&quot;nvariants&quot;</span><span class="p">:</span> <span class="n">variants_per_lib</span><span class="p">}</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libs</span>
    <span class="p">},</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">CodonVariantTable_h2</span> <span class="o">=</span> <span class="n">dms_variants</span><span class="o">.</span><span class="n">simulate</span><span class="o">.</span><span class="n">simulate_CodonVariantTable</span><span class="p">(</span>
    <span class="n">geneseq</span><span class="o">=</span><span class="n">geneseq_h2</span><span class="p">,</span>
    <span class="n">bclen</span><span class="o">=</span><span class="n">bclen</span><span class="p">,</span>
    <span class="n">library_specs</span><span class="o">=</span><span class="p">{</span>
        <span class="n">lib</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;avgmuts&quot;</span><span class="p">:</span> <span class="n">avgmuts</span><span class="p">,</span> <span class="s2">&quot;nvariants&quot;</span><span class="p">:</span> <span class="n">variants_per_lib</span><span class="p">}</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libs</span>
    <span class="p">},</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[191]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">n_variants_df</span><span class="p">(</span><span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[191]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>sample</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>barcoded variants</td>
      <td>50000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_2</td>
      <td>barcoded variants</td>
      <td>50000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>all libraries</td>
      <td>barcoded variants</td>
      <td>100000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>plot the number of variant support sequences as a histogram</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[192]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">plotVariantSupportHistogram</span><span class="p">(</span><span class="n">max_support</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">theme_classic</span><span class="p">()</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">theme</span><span class="p">(</span>
    <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_43_0.png" src="_images/simulation_validation_43_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[193]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">n_variants_df</span><span class="p">(</span><span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[193]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>sample</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>barcoded variants</td>
      <td>50000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_2</td>
      <td>barcoded variants</td>
      <td>50000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>all libraries</td>
      <td>barcoded variants</td>
      <td>100000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[194]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">plotVariantSupportHistogram</span><span class="p">(</span><span class="n">max_support</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">theme_classic</span><span class="p">()</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">theme</span><span class="p">(</span>
    <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_45_0.png" src="_images/simulation_validation_45_0.png" />
</div>
</div>
</section>
<section id="Variant-phenotypes-and-enrichments">
<h2>Variant phenotypes and enrichments<a class="headerlink" href="#Variant-phenotypes-and-enrichments" title="Permalink to this heading">¶</a></h2>
<p>Now that we have simulated libraries of variants <span class="math notranslate nohighlight">\(v_i \in V\)</span>, we’ll assign their respective ground truth phenotypes and enrichments.</p>
<p>We’ll start by computing latent phenotype, <span class="math notranslate nohighlight">\(\phi(v_i)\)</span>. Recall that each of the two homologs has a <code class="docutils literal notranslate"><span class="pre">SigmoidPhenotypeSimulator</span></code> object that stores the latent effects of individual mutations. We will use these objects to compute the latent phenotypes of all variants in the libraries.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[195]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we&#39;ll store a collection of functions for each homolog</span>
<span class="n">phenotype_fxn_dict_h1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;latentPhenotype&quot;</span> <span class="p">:</span> <span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">latentPhenotype</span><span class="p">}</span>
<span class="n">phenotype_fxn_dict_h2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;latentPhenotype&quot;</span> <span class="p">:</span> <span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">latentPhenotype</span><span class="p">}</span>

<span class="c1"># add the latent phenotype to the barcode variant table</span>
<span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;latent_phenotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;latentPhenotype&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;latent_phenotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;latentPhenotype&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># print a sample of the variant table</span>
<span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[195]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>aa_substitutions</th>
      <th>latent_phenotype</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>S12F P43F</td>
      <td>2.696775</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_1</td>
      <td>L33P</td>
      <td>5.253866</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lib_1</td>
      <td>N3V F16S</td>
      <td>4.413085</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lib_1</td>
      <td>N22W L49I</td>
      <td>-1.817175</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lib_1</td>
      <td>K21N</td>
      <td>4.402149</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[196]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[196]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>aa_substitutions</th>
      <th>latent_phenotype</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>T12F P43F</td>
      <td>0.687919</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_1</td>
      <td>L33P</td>
      <td>3.665115</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lib_1</td>
      <td>N3V F16S</td>
      <td>2.824335</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lib_1</td>
      <td>N22W L49I</td>
      <td>-3.405926</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lib_1</td>
      <td>K21N</td>
      <td>2.813398</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Next, we can compute an <em>observed phenotype</em>, <span class="math notranslate nohighlight">\(p(v, d)\)</span> = <span class="math notranslate nohighlight">\(g_{\theta}(\phi(v, d))\)</span>, where <span class="math notranslate nohighlight">\(g_{\theta}\)</span> is the global epistasis function implimented as a flexible sigmoid with two free parameters, <span class="math notranslate nohighlight">\(\theta_{s}\)</span> and <span class="math notranslate nohighlight">\(\theta_{b}\)</span>, that serve as a scale and bias, respectively. Concretely, <span class="math notranslate nohighlight">\(g_{\theta}(z) = \theta_{b} + \frac{\theta_{s}}{1 + e^{-z}}\)</span>. For the purposes of this analysis, we compute a fixed value for the <span class="math notranslate nohighlight">\(\theta_{b}\)</span> parameter, based upon the
specified parameters for <span class="math notranslate nohighlight">\(\theta_{s}\)</span> (<code class="docutils literal notranslate"><span class="pre">sigmoid_phenotype_scale</span></code>) and <span class="math notranslate nohighlight">\(\phi(v_{WT})\)</span> (<code class="docutils literal notranslate"><span class="pre">wt_latent</span></code>) such that the reference wildtype phenotype is exactly 0.</p>
<p>Note that while the <code class="docutils literal notranslate"><span class="pre">SigmoidPhenotypeSimulator</span></code> object (as the name suggests) provides its own global epistasis object for computing phenotype and enrichments, we will only be using it to get mutational effects and the associated latent phenotypes. For computing the post-latent phenotypes and enrichments, we will use the <code class="docutils literal notranslate"><span class="pre">multidms</span></code> biophysical model such that we’re simulating under the same model we’ll be fitting as described above.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[197]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define numpy wrapper for multidms native jax sigmoid fxn</span>
<span class="k">def</span><span class="w"> </span><span class="nf">g</span><span class="p">(</span><span class="n">z</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">ge_scale</span><span class="o">=</span><span class="n">sigmoid_phenotype_scale</span><span class="p">,</span> <span class="n">wt_latent</span><span class="o">=</span><span class="n">wt_latent</span><span class="p">):</span>

    <span class="c1"># ensure the reference phenotype is 0</span>
    <span class="n">ge_bias</span> <span class="o">=</span> <span class="o">-</span><span class="n">sigmoid_phenotype_scale</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">wt_latent</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ge_bias</span> <span class="o">+</span> <span class="p">(</span><span class="n">ge_scale</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">z</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[198]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_latent</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[198]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[199]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span><span class="p">(</span><span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[199]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
np.float64(-0.15151731588729156)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[200]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">wt_latent</span><span class="o">=</span><span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[200]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
np.float64(0.15151731588729156)
</pre></div></div>
</div>
<p>Visualize the sigmoidal function that we’ll be using to map latent phenotypes to observed phenotypes. Place vertical line at the reference (“h1”) wildtype latent phenotype, as well as a dashed line for the non-reference (“h2”) phenotype:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[201]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">resolution</span><span class="p">),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">resolution</span><span class="p">))))</span>
            <span class="p">}</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;latent phenotype&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;observed phenotype&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_56_0.png" src="_images/simulation_validation_56_0.png" />
</div>
</div>
<p>Next, assign each barcoded variant an <em>observed phenotype</em>, <span class="math notranslate nohighlight">\(p(v, d)\)</span>, as well as an <em>observed enrichment</em> , <span class="math notranslate nohighlight">\(2^{p(v, d)}\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[202]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subs</span> <span class="o">=</span> <span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span>
<span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">g</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;latentPhenotype&quot;</span><span class="p">](</span><span class="n">x</span><span class="p">)))</span><span class="c1"># - g(float(wt_latent))</span>
<span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;observed_phenotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;observedEnrichment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">](</span><span class="n">x</span><span class="p">))</span>
<span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;observed_enrichment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">phenotype_fxn_dict_h1</span><span class="p">[</span><span class="s2">&quot;observedEnrichment&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">subs</span> <span class="o">=</span> <span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span>
<span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">g</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;latentPhenotype&quot;</span><span class="p">](</span><span class="n">x</span><span class="p">)))</span> <span class="o">-</span> <span class="n">g</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">))</span>
<span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;observed_phenotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># subtract the wt observed phenotype from all observed phenotypes</span>
<span class="c1"># CodonVariantTable_h2.barcode_variant_df[&#39;observed_phenotype&#39;] -= CodonVariantTable_h2.barcode_variant_df.query(&quot;aa_substitutions == &#39;&#39;&quot;)[&#39;observed_phenotype&#39;].iloc[0]</span>

<span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;observedEnrichment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">](</span><span class="n">x</span><span class="p">))</span>
<span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[</span><span class="s1">&#39;observed_enrichment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="n">phenotype_fxn_dict_h2</span><span class="p">[</span><span class="s2">&quot;observedEnrichment&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">variants_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">homolog</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span>
        <span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">homolog</span><span class="o">=</span><span class="s2">&quot;h2&quot;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">variants_df</span><span class="p">[[</span><span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;observed_enrichment&quot;</span><span class="p">,</span> <span class="s2">&quot;homolog&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[202]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>aa_substitutions</th>
      <th>latent_phenotype</th>
      <th>observed_phenotype</th>
      <th>observed_enrichment</th>
      <th>homolog</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>S12F P43F</td>
      <td>2.696775</td>
      <td>-0.338826</td>
      <td>0.790684</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>L33P</td>
      <td>5.253866</td>
      <td>0.008957</td>
      <td>1.006228</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>N3V F16S</td>
      <td>4.413085</td>
      <td>-0.031679</td>
      <td>0.978281</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>N22W L49I</td>
      <td>-1.817175</td>
      <td>-5.121204</td>
      <td>0.028732</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>K21N</td>
      <td>4.402149</td>
      <td>-0.032459</td>
      <td>0.977752</td>
      <td>h1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[203]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variants_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;aa_substitutions == &#39;&#39; &amp; homolog == &#39;h2&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[203]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>barcode</th>
      <th>variant_call_support</th>
      <th>codon_substitutions</th>
      <th>aa_substitutions</th>
      <th>n_codon_substitutions</th>
      <th>n_aa_substitutions</th>
      <th>latent_phenotype</th>
      <th>observed_phenotype</th>
      <th>observed_enrichment</th>
      <th>homolog</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>lib_1</td>
      <td>AAAAAACGATCGAGCT</td>
      <td>3</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>12</th>
      <td>lib_1</td>
      <td>AAAAAATCCGCGCCCG</td>
      <td>3</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>13</th>
      <td>lib_1</td>
      <td>AAAAAATCGAATTCAG</td>
      <td>1</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>14</th>
      <td>lib_1</td>
      <td>AAAAAATCTCTGATCT</td>
      <td>1</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>29</th>
      <td>lib_1</td>
      <td>AAAAACTAATAGAACC</td>
      <td>4</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>99965</th>
      <td>lib_2</td>
      <td>TTTTTCAACAAACTCA</td>
      <td>3</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>99968</th>
      <td>lib_2</td>
      <td>TTTTTCGCCCGCCTTC</td>
      <td>1</td>
      <td>TTC45TTT</td>
      <td></td>
      <td>1</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>99973</th>
      <td>lib_2</td>
      <td>TTTTTGAATCTAGTGA</td>
      <td>1</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>99980</th>
      <td>lib_2</td>
      <td>TTTTTGCTGCTCACCG</td>
      <td>1</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
    <tr>
      <th>99984</th>
      <td>lib_2</td>
      <td>TTTTTGGCGTGGACAC</td>
      <td>1</td>
      <td></td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>3.411249</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>h2</td>
    </tr>
  </tbody>
</table>
<p>14676 rows × 11 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<p>Note that The enrichment score transforms phenotypes to be between 0 and 1, and can thus be used to compute the number of counts for each variant in the post-selection library using a multinomial distribution where the probability of observing a variant is proportional to its enrichment. Below, we plot each variant’s latent phenotype against its observed enrichment:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[204]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">variants_df</span><span class="p">,</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">,</span>
            <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;observed_enrichment&quot;</span><span class="p">,</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;homolog&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">SigmoidPhenotype_h1</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">SigmoidPhenotype_h2</span><span class="o">.</span><span class="n">wt_latent</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;$\phi$&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;observed enrichment&quot;</span>
    <span class="p">)</span>
    <span class="c1"># zoom in on the x axis limits</span>
    <span class="o">+</span> <span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_62_0.png" src="_images/simulation_validation_62_0.png" />
</div>
</div>
</section>
<section id="Pre-and-post-selection-variant-read-counts">
<h2>Pre and post-selection variant read counts<a class="headerlink" href="#Pre-and-post-selection-variant-read-counts" title="Permalink to this heading">¶</a></h2>
<p>Next, we will simulate both pre and post-selection counts of each variant subjected to an experimental selection step. Post-selection counts will be simulated by applying the specified selection bottleneck(s) to the pre-selection counts. To do this, we will use the functionality provided by <a class="reference external" href="https://jbloomlab.github.io/dms_variants/dms_variants.simulate.html#dms_variants.simulate.simulateSampleCounts">dms_variants.simulate.simulateSampleCounts</a> and feed it our custom phenotype function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[205]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bottlenecks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">variants_per_lib</span> <span class="o">*</span> <span class="n">scalar</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scalar</span> <span class="ow">in</span> <span class="n">bottleneck_variants_per_lib_scalar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># do this independently for each of the homologs.</span>
<span class="n">counts_h1</span><span class="p">,</span> <span class="n">counts_h2</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dms_variants</span><span class="o">.</span><span class="n">simulate</span><span class="o">.</span><span class="n">simulateSampleCounts</span><span class="p">(</span>
        <span class="n">variants</span><span class="o">=</span><span class="n">variants</span><span class="p">,</span>
        <span class="n">phenotype_func</span><span class="o">=</span><span class="n">pheno_fxn_dict</span><span class="p">[</span><span class="s2">&quot;observedEnrichment&quot;</span><span class="p">],</span>
        <span class="n">variant_error_rate</span><span class="o">=</span><span class="n">variant_error_rate</span><span class="p">,</span>
        <span class="n">pre_sample</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">variants_per_lib</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">avgdepth_per_variant</span><span class="p">),</span>
            <span class="s2">&quot;uniformity&quot;</span><span class="p">:</span> <span class="n">lib_uniformity</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">pre_sample_name</span><span class="o">=</span><span class="s2">&quot;pre-selection&quot;</span><span class="p">,</span>
        <span class="n">post_samples</span><span class="o">=</span><span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;noise&quot;</span><span class="p">:</span> <span class="n">noise</span><span class="p">,</span>
                <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">variants_per_lib</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">avgdepth_per_variant</span><span class="p">),</span>
                <span class="s2">&quot;bottleneck&quot;</span><span class="p">:</span> <span class="n">bottleneck</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">bottleneck</span> <span class="ow">in</span> <span class="n">bottlenecks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">variants</span><span class="p">,</span> <span class="n">pheno_fxn_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="n">CodonVariantTable_h1</span><span class="p">,</span> <span class="n">CodonVariantTable_h2</span><span class="p">],</span> <span class="p">[</span><span class="n">phenotype_fxn_dict_h1</span><span class="p">,</span> <span class="n">phenotype_fxn_dict_h2</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>
<span class="n">CodonVariantTable_h1</span><span class="o">.</span><span class="n">add_sample_counts_df</span><span class="p">(</span><span class="n">counts_h1</span><span class="p">)</span>
<span class="n">CodonVariantTable_h2</span><span class="o">.</span><span class="n">add_sample_counts_df</span><span class="p">(</span><span class="n">counts_h2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Plot the number of counts for each variant in each sample. The horizontal dashed line shows the total number of variants. The plot shows that all variants are well-sampled in the pre-selection libraries, but that post- selection some variants are sampled more or less. This is expected since selection will decrease and increase the frequency of variants:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[206]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">variants</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">CodonVariantTable_h1</span><span class="p">,</span> <span class="n">CodonVariantTable_h2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;homolog 1&#39;</span><span class="p">,</span> <span class="s1">&#39;homolog 2&#39;</span><span class="p">]):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">plotCumulVariantCounts</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_67_0.png" src="_images/simulation_validation_67_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_67_1.png" src="_images/simulation_validation_67_1.png" />
</div>
</div>
<p>Distribution of the number of amino-acid mutations per variant in each sample. As expected, mutations go down after selection:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[207]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">variants</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">CodonVariantTable_h1</span><span class="p">,</span> <span class="n">CodonVariantTable_h2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;homolog 1&#39;</span><span class="p">,</span> <span class="s1">&#39;homolog 2&#39;</span><span class="p">]):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">plotNumMutsHistogram</span><span class="p">(</span><span class="n">mut_type</span><span class="o">=</span><span class="s2">&quot;aa&quot;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_69_0.png" src="_images/simulation_validation_69_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_69_1.png" src="_images/simulation_validation_69_1.png" />
</div>
</div>
<p>Plot how thoroughly amino-acid mutations are sampled. The plots below show that the stop mutations are sampled very poorly post-selection because they are eliminated during selection:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[208]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">variants</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">CodonVariantTable_h1</span><span class="p">,</span> <span class="n">CodonVariantTable_h2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;homolog 1&#39;</span><span class="p">,</span> <span class="s1">&#39;homolog 2&#39;</span><span class="p">]):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">variants</span><span class="o">.</span><span class="n">plotCumulMutCoverage</span><span class="p">(</span><span class="n">variant_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">mut_type</span><span class="o">=</span><span class="s2">&quot;aa&quot;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">theme</span><span class="p">(</span><span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_71_0.png" src="_images/simulation_validation_71_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_71_1.png" src="_images/simulation_validation_71_1.png" />
</div>
</div>
</section>
<section id="Prep-training-data">
<h2>Prep training data<a class="headerlink" href="#Prep-training-data" title="Permalink to this heading">¶</a></h2>
<p>Prepare the training dataframes for fitting our <code class="docutils literal notranslate"><span class="pre">multidms</span></code> models.</p>
<p>As this is a joint-fitting approach, we combine homolog variants from each of the corresponding library replicates into a single training dataset. Additionally, for each replicate dataset, we’ll train models on each of the following targets representing different levels of noise in the data:</p>
<ol class="arabic simple">
<li><p>Ground truth <em>observed phenotype</em> - this target acts as a control and benchmarks the ability of the model to recover the true latent effects and shifts controlling for other sources of noise.</p></li>
<li><p><em>Loose bottleneck</em> counts derived functional scores - these scores are derived from the observed enrichments, and used to asses model performance in the context of realistic experimental noise.</p></li>
<li><p><em>Tight bottleneck</em> counts derived functional scores - the same as above, but with a tighter bottleneck for more extreme cases of noise.</p></li>
</ol>
<p>For further details on how to prepare data and fit models, see the <code class="docutils literal notranslate"><span class="pre">multidms</span></code> <a class="reference external" href="https://matsengrp.github.io/multidms/fit_delta_BA1_example.html">quick-start tutorial</a>.</p>
<p>Start by creating training data with ground truth phenotype target. Because the barcode replicates share ground truth phenotypes we can can collapse the counts accross replicates by simple dropping duplicates.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[209]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">variants</span><span class="o">.</span><span class="n">variant_count_df</span><span class="o">.</span><span class="n">barcode</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[209]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
np.False_
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[210]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variants</span><span class="o">.</span><span class="n">variant_count_df</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[210]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sample
pre-selection    100000
loose_bottle     100000
tight_bottle     100000
Name: count, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[211]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variants</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[211]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
library
lib_1    50000
lib_2    50000
Name: count, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[212]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">req_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;homolog&quot;</span><span class="p">,</span> <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;func_score_type&quot;</span><span class="p">,</span> <span class="s2">&quot;func_score&quot;</span><span class="p">]</span>
<span class="n">ground_truth_training_set</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">variants</span><span class="o">.</span><span class="n">barcode_variant_df</span><span class="p">[[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">homolog</span><span class="o">=</span><span class="n">homolog</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">variants</span><span class="p">,</span> <span class="n">homolog</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">CodonVariantTable_h1</span><span class="p">,</span> <span class="n">CodonVariantTable_h2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;h2&#39;</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;homolog&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">],</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">],</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;func_score_type&quot;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;func_score&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="n">req_cols</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ground_truth_training_set</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[212]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>homolog</th>
      <th>aa_substitutions</th>
      <th>func_score_type</th>
      <th>func_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>S12F P43F</td>
      <td>observed_phenotype</td>
      <td>-0.34</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>L33P</td>
      <td>observed_phenotype</td>
      <td>0.01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>N3V F16S</td>
      <td>observed_phenotype</td>
      <td>-0.03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>N22W L49I</td>
      <td>observed_phenotype</td>
      <td>-5.12</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>K21N</td>
      <td>observed_phenotype</td>
      <td>-0.03</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[213]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ground_truth_training_set</span><span class="o">.</span><span class="n">aa_substitutions</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[213]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
aa_substitutions
N3L P25A               4
R14D                   4
D11I                   4
L33W                   4
W40Y                   4
                      ..
V39L V47D              1
S5G H24R E28Y L33Y     1
Q8L S12T L23M P43L     1
K21R H31L G35I Y42I    1
W8Y P43V               1
Name: count, Length: 83677, dtype: int64
</pre></div></div>
</div>
<p>Next, compute functional scores from pre-post counts in each bottleneck <em>after</em> aggregating the barcode replicate counts for unique variants. The <a class="reference external" href="https://jbloomlab.github.io/dms_variants/dms_variants.codonvarianttable.html#dms_variants.codonvarianttable.CodonVariantTable.func_scores">dms_variants.CodonVariantTable.func_scores</a> method provides the ability to compute functional scores from pre and post-selection counts. We’ll use this to compute functional scores for each of the three targets:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[214]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bottle_cbf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">variants</span>
            <span class="o">.</span><span class="n">func_scores</span><span class="p">(</span><span class="s2">&quot;pre-selection&quot;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="n">libraries</span><span class="o">=</span><span class="n">libs</span><span class="p">,</span> <span class="n">syn_as_wt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">homolog</span><span class="o">=</span><span class="n">homolog</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;post_sample&quot;</span><span class="p">:</span><span class="s2">&quot;func_score_type&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># [req_cols]</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">c</span><span class="p">:</span><span class="nb">str</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">req_cols</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">variants</span><span class="p">,</span> <span class="n">homolog</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">CodonVariantTable_h1</span><span class="p">,</span> <span class="n">CodonVariantTable_h2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;h2&#39;</span><span class="p">])</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">bottle_cbf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[214]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>pre_sample</th>
      <th>func_score_type</th>
      <th>aa_substitutions</th>
      <th>func_score</th>
      <th>func_score_var</th>
      <th>pre_count</th>
      <th>post_count</th>
      <th>pre_count_wt</th>
      <th>post_count_wt</th>
      <th>pseudocount</th>
      <th>n_aa_substitutions</th>
      <th>homolog</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>pre-selection</td>
      <td>loose_bottle</td>
      <td>S5I G7R F34A</td>
      <td>-0.167084</td>
      <td>0.003633</td>
      <td>907</td>
      <td>1556</td>
      <td>1508174</td>
      <td>2904366</td>
      <td>0.5</td>
      <td>3</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_1</td>
      <td>pre-selection</td>
      <td>loose_bottle</td>
      <td>V15G</td>
      <td>-2.168313</td>
      <td>0.001447</td>
      <td>4802</td>
      <td>2057</td>
      <td>1508174</td>
      <td>2904366</td>
      <td>0.5</td>
      <td>1</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lib_1</td>
      <td>pre-selection</td>
      <td>loose_bottle</td>
      <td>S12F V41G</td>
      <td>0.094183</td>
      <td>0.003961</td>
      <td>781</td>
      <td>1606</td>
      <td>1508174</td>
      <td>2904366</td>
      <td>0.5</td>
      <td>2</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lib_1</td>
      <td>pre-selection</td>
      <td>loose_bottle</td>
      <td>M29S</td>
      <td>-0.006238</td>
      <td>0.000505</td>
      <td>6292</td>
      <td>12065</td>
      <td>1508174</td>
      <td>2904366</td>
      <td>0.5</td>
      <td>1</td>
      <td>h1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lib_1</td>
      <td>pre-selection</td>
      <td>loose_bottle</td>
      <td></td>
      <td>0.000000</td>
      <td>0.000004</td>
      <td>1508174</td>
      <td>2904366</td>
      <td>1508174</td>
      <td>2904366</td>
      <td>0.5</td>
      <td>0</td>
      <td>h1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[215]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bottle_cbf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/simulated_bottleneck_cbf.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, combine the two dataframes computed above and classify the variants based on the number of amino acid substitutions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[216]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">classify_variant</span><span class="p">(</span><span class="n">aa_subs</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">aa_subs</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;stop&quot;</span>
    <span class="k">elif</span> <span class="n">aa_subs</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;wildtype&quot;</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa_subs</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;1 nonsynonymous&quot;</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa_subs</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&gt;1 nonsynonymous&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unexpected aa_subs: </span><span class="si">{</span><span class="n">aa_subs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">func_scores</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ground_truth_training_set</span><span class="p">,</span> <span class="n">bottle_cbf</span><span class="p">])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">variant_class</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">classify_variant</span><span class="p">))</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">variants_df</span><span class="p">[[</span><span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;homolog&quot;</span><span class="p">,</span> <span class="s2">&quot;latent_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;homolog&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># categorical for plotting</span>
<span class="n">func_scores</span><span class="p">[</span><span class="s2">&quot;func_score_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">func_scores</span><span class="p">[</span><span class="s2">&quot;func_score_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">func_scores</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[216]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>homolog</th>
      <th>aa_substitutions</th>
      <th>func_score_type</th>
      <th>func_score</th>
      <th>pre_sample</th>
      <th>func_score_var</th>
      <th>pre_count</th>
      <th>post_count</th>
      <th>pre_count_wt</th>
      <th>post_count_wt</th>
      <th>pseudocount</th>
      <th>n_aa_substitutions</th>
      <th>variant_class</th>
      <th>latent_phenotype</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>S12F P43F</td>
      <td>observed_phenotype</td>
      <td>-0.338826</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>&gt;1 nonsynonymous</td>
      <td>2.696775</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>L33P</td>
      <td>observed_phenotype</td>
      <td>0.008957</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1 nonsynonymous</td>
      <td>5.253866</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>N3V F16S</td>
      <td>observed_phenotype</td>
      <td>-0.031679</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>&gt;1 nonsynonymous</td>
      <td>4.413085</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>N22W L49I</td>
      <td>observed_phenotype</td>
      <td>-5.121204</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>&gt;1 nonsynonymous</td>
      <td>-1.817175</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>K21N</td>
      <td>observed_phenotype</td>
      <td>-0.032459</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1 nonsynonymous</td>
      <td>4.402149</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>349861</th>
      <td>lib_2</td>
      <td>h2</td>
      <td>T4C N22A E28V</td>
      <td>tight_bottle</td>
      <td>-0.872689</td>
      <td>pre-selection</td>
      <td>0.225674</td>
      <td>17.0</td>
      <td>19.0</td>
      <td>1631741.0</td>
      <td>3329303.0</td>
      <td>0.5</td>
      <td>3.0</td>
      <td>&gt;1 nonsynonymous</td>
      <td>0.016912</td>
    </tr>
    <tr>
      <th>349862</th>
      <td>lib_2</td>
      <td>h2</td>
      <td>L2S A10S E28L</td>
      <td>tight_bottle</td>
      <td>-0.428415</td>
      <td>pre-selection</td>
      <td>0.222853</td>
      <td>15.0</td>
      <td>23.0</td>
      <td>1631741.0</td>
      <td>3329303.0</td>
      <td>0.5</td>
      <td>3.0</td>
      <td>&gt;1 nonsynonymous</td>
      <td>0.329871</td>
    </tr>
    <tr>
      <th>349863</th>
      <td>lib_2</td>
      <td>h2</td>
      <td>T4H D18S</td>
      <td>tight_bottle</td>
      <td>-1.590687</td>
      <td>pre-selection</td>
      <td>0.332509</td>
      <td>15.0</td>
      <td>10.0</td>
      <td>1631741.0</td>
      <td>3329303.0</td>
      <td>0.5</td>
      <td>2.0</td>
      <td>&gt;1 nonsynonymous</td>
      <td>0.215730</td>
    </tr>
    <tr>
      <th>349864</th>
      <td>lib_2</td>
      <td>h2</td>
      <td>T12P A20I V41E</td>
      <td>tight_bottle</td>
      <td>-3.564861</td>
      <td>pre-selection</td>
      <td>0.976092</td>
      <td>14.0</td>
      <td>2.0</td>
      <td>1631741.0</td>
      <td>3329303.0</td>
      <td>0.5</td>
      <td>3.0</td>
      <td>&gt;1 nonsynonymous</td>
      <td>-1.403989</td>
    </tr>
    <tr>
      <th>349865</th>
      <td>lib_2</td>
      <td>h2</td>
      <td>T12A L23T E27A V42G</td>
      <td>tight_bottle</td>
      <td>-1.559323</td>
      <td>pre-selection</td>
      <td>0.782739</td>
      <td>6.0</td>
      <td>4.0</td>
      <td>1631741.0</td>
      <td>3329303.0</td>
      <td>0.5</td>
      <td>4.0</td>
      <td>&gt;1 nonsynonymous</td>
      <td>-6.215249</td>
    </tr>
  </tbody>
</table>
<p>349866 rows × 15 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[217]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">func_scores</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/simulated_functional_scores.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s plot the functional scores as a function of the latent phenotype.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[218]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">func_scores</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;latent_phenotype&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;func_score&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~func_score_type&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_88_0.png" src="_images/simulation_validation_88_0.png" />
</div>
</div>
<p>Plot a pairplot to see how targets compare.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[171]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">func_scores</span>
        <span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;homolog&quot;</span><span class="p">,</span> <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="s2">&quot;variant_class&quot;</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;func_score_type&quot;</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="s2">&quot;func_score&quot;</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;homolog&#39;</span><span class="p">,</span>
    <span class="n">plot_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span><span class="mf">0.25</span><span class="p">},</span>
    <span class="n">corner</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_90_0.png" src="_images/simulation_validation_90_0.png" />
</div>
</div>
<p>We can see here that the tight bottleneck indeed introduces more noise in the data, as the functional scores are less correlated with the ground truth phenotype.</p>
<p>Plot the functional scores distributions of the bottleneck counts-computed functional scores. Recall that we collapsed barcode replicates so there is only a single wildtype phenotype in each of the datasets, thus we will not plot them below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[172]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">func_scores</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(func_score_type != &#39;observed_phenotype&#39;) &amp; (variant_class != &#39;wildtype&#39;)&quot;</span><span class="p">),</span>
        <span class="n">aes</span><span class="p">(</span><span class="s2">&quot;variant_class&quot;</span><span class="p">,</span> <span class="s2">&quot;func_score&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_violin</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;functional score&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_grid</span><span class="p">(</span><span class="s2">&quot;func_score_type ~ library + homolog&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="p">)</span>
    <span class="c1"># + scale_fill_manual(values=CBPALETTE[1:])</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/simulation_validation_93_0.png" src="_images/simulation_validation_93_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[173]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">func_scores</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/simulated_func_scores.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">func_scores</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[173]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>library</th>
      <th>homolog</th>
      <th>aa_substitutions</th>
      <th>func_score_type</th>
      <th>func_score</th>
      <th>pre_sample</th>
      <th>func_score_var</th>
      <th>pre_count</th>
      <th>post_count</th>
      <th>pre_count_wt</th>
      <th>post_count_wt</th>
      <th>pseudocount</th>
      <th>n_aa_substitutions</th>
      <th>variant_class</th>
      <th>latent_phenotype</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>L33P</td>
      <td>observed_phenotype</td>
      <td>0.01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1 nonsynonymous</td>
      <td>5.25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>N3V F16S</td>
      <td>observed_phenotype</td>
      <td>-0.03</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>&gt;1 nonsynonymous</td>
      <td>4.41</td>
    </tr>
    <tr>
      <th>2</th>
      <td>lib_1</td>
      <td>h1</td>
      <td></td>
      <td>observed_phenotype</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>wildtype</td>
      <td>5.00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>L2Q H31*</td>
      <td>observed_phenotype</td>
      <td>-5.93</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>stop</td>
      <td>-5.28</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lib_1</td>
      <td>h1</td>
      <td>N3Y L17N D18I E27R</td>
      <td>observed_phenotype</td>
      <td>-5.04</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>&gt;1 nonsynonymous</td>
      <td>-1.71</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Create-Data-objects-for-each-library-replicate,-and-bottleneck">
<h2>Create <code class="docutils literal notranslate"><span class="pre">Data</span></code> objects for each library replicate, and bottleneck<a class="headerlink" href="#Create-Data-objects-for-each-library-replicate,-and-bottleneck" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">multidms</span></code> model fitting is generally a two-step process: (1) Create <code class="docutils literal notranslate"><span class="pre">Data</span></code> objects from functional score dataframes which, among other things, encode the variant data into one-hot encoded matrices, and (2) fit a collection of models across a grid of <code class="docutils literal notranslate"><span class="pre">Data</span></code> objects and hyperparameters. Here, we’ll create <code class="docutils literal notranslate"><span class="pre">Data</span></code> objects for each library replicate / fitting target combination:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_objects</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">multidms</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span>
        <span class="n">fs_df</span><span class="p">,</span>
        <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span>
        <span class="n">alphabet</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">AAS_WITHSTOP_WITHGAP</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lib</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">_func_score&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span> <span class="n">fs_df</span> <span class="ow">in</span> <span class="n">func_scores</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;homolog&quot;</span><span class="p">:</span><span class="s2">&quot;condition&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="s1">&#39;func_score_type&#39;</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">data_objects</span>
</pre></div>
</div>
</div>
</section>
<section id="Fit-models-to-training-data-(lasso-sweep)">
<h2>Fit models to training data (lasso sweep)<a class="headerlink" href="#Fit-models-to-training-data-(lasso-sweep)" title="Permalink to this heading">¶</a></h2>
<p>Next, we’ll fit a set of models to each of the datasets defined above using the <code class="docutils literal notranslate"><span class="pre">multidms.fit_models</span></code> <a class="reference external" href="https://matsengrp.github.io/multidms/multidms.model_collection.html#multidms.model_collection.fit_models">function</a>. For each dataset, we independently fit models with a number of different lasso penalty coefficients (<span class="math notranslate nohighlight">\(\lambda_{L1}\)</span>) as defined at the top of this notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitting_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &quot;num_training_steps&quot;: [num_training_steps], # default 100</span>
    <span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10000</span><span class="p">],</span> <span class="c1"># default 20000</span>
    <span class="s2">&quot;tol&quot;</span><span class="p">:[</span><span class="mf">0.0001</span><span class="p">],</span>
    <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">:</span> <span class="n">coef_lasso_shift</span><span class="p">,</span> <span class="c1"># the sweep of lasso coefficient params</span>
    <span class="s2">&quot;init_beta0&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">init_beta0</span><span class="p">],</span> <span class="c1"># We&#39;ve found that we need to start with a higher beta0 to get the model to converge correctly,</span>
    <span class="s2">&quot;coef_ridge_beta&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">coef_ridge_beta</span><span class="p">],</span> <span class="c1"># the sweep of ridge coefficient params</span>
    <span class="s2">&quot;acceleration&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">],</span> <span class="c1"># default True</span>
    <span class="s2">&quot;maxls&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">fitting_params</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_objects</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">fitting_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">_explode_params_dict</span><span class="p">(</span><span class="n">fitting_params</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">fit_one_model</span><span class="p">(</span><span class="o">**</span><span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">_explode_params_dict</span><span class="p">(</span><span class="n">fitting_params</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Fit the models:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fit_collection_df</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span><span class="p">(</span><span class="n">fitting_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that the return type of <a class="reference external" href="https://matsengrp.github.io/multidms/multidms.html#multidms.fit_models">multidms.fit_models</a> is a <code class="docutils literal notranslate"><span class="pre">tuple(int,</span> <span class="pre">int,</span> <span class="pre">pd.DataFrame)</span></code> where the first two values are the number of fits that were successful and the number that failed, respectively, and the third value is a dataframe where each row contains a fit <code class="docutils literal notranslate"><span class="pre">Model</span></code> object and the hyperparameters used to fit it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_collection_df</span><span class="p">[[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset_name&quot;</span><span class="p">,</span> <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;fit_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Add a few helpful features to this dataframe for plotting by splitting the “dataset_name” (name of the Data Object that was used for fitting) into more understandable columns:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_collection_df</span> <span class="o">=</span> <span class="n">fit_collection_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">measurement_type</span> <span class="o">=</span> <span class="n">fit_collection_df</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span>
    <span class="n">library</span> <span class="o">=</span> <span class="n">fit_collection_df</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># convert measurement type to categorical ordered by &#39;observed&#39;, &#39;loose&#39;, &#39;tight&#39; for plotting</span>
<span class="n">fit_collection_df</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">fit_collection_df</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">fit_collection_df</span><span class="p">[[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Model-convergence">
<h2>Model convergence<a class="headerlink" href="#Model-convergence" title="Permalink to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %load_ext autoreload</span>
<span class="c1"># %autoreload 2</span>

<span class="c1"># import multidms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model_collection_100K_50_w_wo_acceleration = model_collection</span>
<span class="n">model_collection</span> <span class="o">=</span> <span class="n">model_collection_100K_50_w_wo_acceleration</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_collection</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">ModelCollection</span><span class="p">(</span><span class="n">fit_collection_df</span><span class="p">)</span>
<span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span><span class="o">.</span><span class="n">converged</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">convergence_trajectory_df</span><span class="p">(</span>
    <span class="n">id_vars</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;acceleration&quot;</span><span class="p">,</span> <span class="s2">&quot;maxls&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
<span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~acceleration &amp; step &gt; 90000 &amp; library == &#39;lib_1&#39; &amp; coef_lasso_shift == 4e-05&quot;</span><span class="p">),</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~coef_lasso_shift+measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># copnstrain y axis to 0-1</span>
    <span class="c1"># + scale_y_continuous(limits=(0, .1))</span>
    <span class="c1"># make figure size taller</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="c1"># add title</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
        <span class="c1"># title=&quot;acceleration=False&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;acceleration &amp; step &gt; 3000 &amp; library == &#39;lib_1&#39;&quot;</span><span class="p">),</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~coef_lasso_shift+measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># copnstrain y axis to 0-1</span>
    <span class="c1"># + scale_y_continuous(limits=(0, .1))</span>
    <span class="c1"># make figure size taller</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;acceleration &amp; step &gt; 3000 &amp; library == &#39;lib_1&#39;&quot;</span><span class="p">),</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~coef_lasso_shift+measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># copnstrain y axis to 0-1</span>
    <span class="c1"># + scale_y_continuous(limits=(0, .1))</span>
    <span class="c1"># make figure size taller</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Model-vs.-truth-mutational-effects">
<h2>Model vs. truth mutational effects<a class="headerlink" href="#Model-vs.-truth-mutational-effects" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">multidms.ModelCollection</span></code> takes a a dataframe such as the one created above and provides a few helpful methods for model selection and aggregation. We’ll use these methods to evaluate the fits and select the best model for each dataset.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_collection</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">ModelCollection</span><span class="p">(</span><span class="n">fit_collection_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span><span class="o">.</span><span class="n">converged</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chart_no_bottle</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">mut_param_dataset_correlation</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;measurement_type == &#39;observed_phenotype&#39;&quot;</span><span class="p">)</span>
<span class="n">chart_loose_bottle</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">mut_param_dataset_correlation</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;measurement_type == &#39;loose_bottle&#39;&quot;</span><span class="p">)</span>
<span class="n">chart_tight_bottle</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">mut_param_dataset_correlation</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s2">&quot;measurement_type == &#39;tight_bottle&#39;&quot;</span><span class="p">)</span>
<span class="n">chart_no_bottle</span> <span class="o">|</span> <span class="n">chart_loose_bottle</span> <span class="o">|</span> <span class="n">chart_tight_bottle</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">model_collection</span>
    <span class="o">.</span><span class="n">fit_models</span>
    <span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;coef_lasso_shift == 8.0e-5 and measurement_type == &#39;loose_bottle&#39; and library == &#39;lib_1&#39;&quot;</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">model</span>
    <span class="o">.</span><span class="n">plot_epistasis</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Get the mutational parameters for each of the models using <code class="docutils literal notranslate"><span class="pre">model_collection.split_apply_combine_muts()</span></code> <a class="reference external" href="https://matsengrp.github.io/multidms/multidms.model_collection.html#multidms.model_collection.ModelCollection.split_apply_combine_muts">method</a>, and merge them with the simulated ground truth parameters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the columns that distinguish fits are what we&#39;ll groupby such that none of the model collection parameters are aggregated</span>
<span class="n">groupby</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">)</span>
<span class="n">collection_muts_df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">model_collection</span><span class="o">.</span><span class="n">split_apply_combine_muts</span><span class="p">(</span>
        <span class="n">groupby</span><span class="o">=</span><span class="n">groupby</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;beta&#39;</span> <span class="p">:</span> <span class="s1">&#39;predicted_beta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shift_h2&#39;</span> <span class="p">:</span> <span class="s1">&#39;predicted_shift_h2&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">mut_effects_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;beta_h1&#39;</span> <span class="p">:</span> <span class="s1">&#39;true_beta&#39;</span><span class="p">,</span>
                <span class="s1">&#39;beta_h2&#39;</span> <span class="p">:</span> <span class="s1">&#39;true_beta_h2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;shift&#39;</span> <span class="p">:</span> <span class="s1">&#39;true_shift&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;mutation&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">assert</span> <span class="n">collection_muts_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mut_effects_df</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_collection_df</span><span class="p">)</span>
<span class="n">collection_muts_df</span><span class="p">[[</span><span class="s2">&quot;mutation&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;predicted_shift_h2&quot;</span><span class="p">,</span> <span class="s2">&quot;true_shift&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>To compare model fits parameter values to the simulated ground truth values, add mean squared error and pearsonr metrics to the <code class="docutils literal notranslate"><span class="pre">ModelCollection.fit_models</span></code> attribute:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">series_corr</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">series_mae</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="c1"># compute the new metric columns</span>
<span class="n">new_fit_models_cols</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">model_mutations_df</span> <span class="ow">in</span> <span class="n">collection_muts_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">groupby</span><span class="p">)):</span>
    <span class="c1"># add cols for merging</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
        <span class="n">new_fit_models_cols</span><span class="p">[</span><span class="n">groupby</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;shift&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">metric_fxn</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">series_corr</span><span class="p">,</span> <span class="n">series_mae</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;corr&quot;</span><span class="p">,</span> <span class="s2">&quot;mae&quot;</span><span class="p">]):</span>

            <span class="c1"># add the new metric columns</span>
            <span class="n">postfix</span><span class="o">=</span><span class="s2">&quot;_h2&quot;</span> <span class="k">if</span> <span class="n">parameter</span> <span class="o">==</span> <span class="s2">&quot;shift&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model_mutations_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;predicted_</span><span class="si">{</span><span class="n">parameter</span><span class="si">}{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">y_true</span> <span class="o">=</span> <span class="n">model_mutations_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;true_</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">new_fit_models_cols</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_fxn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

<span class="c1"># merge the new columns into the model collection</span>
<span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_fit_models_cols</span><span class="p">),</span>
    <span class="n">on</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># print the first few rows of the model collection</span>
<span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_fit_models_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<p>Next, we’ll make some summary plots with the predicted vs. simulated ground MSE truth parameters across model fits</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metric</span> <span class="o">=</span> <span class="s2">&quot;corr&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">measurement_library</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;measurement_library&quot;</span><span class="p">],</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;beta_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;shift_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;parameter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;parameter&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;shift&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">parameter_df</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ggplot</span><span class="p">(</span><span class="n">parameter_df</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                <span class="n">group</span><span class="o">=</span><span class="s2">&quot;measurement_library&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
            <span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
            <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">),</span>
            <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
            <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Prediction vs. Simulated Ground Truth: </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;lasso penalty coefficient (λ)&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Mean Absolute Error&quot;</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;mae&quot;</span> <span class="k">else</span> <span class="s2">&quot;Correlation&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/model_vs_truth_beta_shift.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Shift-sparsity">
<h2>Shift sparsity<a class="headerlink" href="#Shift-sparsity" title="Permalink to this heading">¶</a></h2>
<p>Another way we might evaluate the fits is by looking at the <em>sparsity</em> of the models by computing the percentage of shift parameters that are equal to zero among the models. We look at this metric separately for mutations to stop codons and mutations to non-stop codons because we expect the stop codons to be equally deleterious in both homologs, and thus we expect all the shift parameters associated with stop codon mutations to be zero in a “good” fit.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chart</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">shift_sparsity</span><span class="p">(</span><span class="n">return_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">library</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dataset_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span>
    <span class="n">library_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dataset_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">mut_type</span><span class="p">,</span>
    <span class="n">measurement_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dataset_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># convert measurement type to categorical ordered by &#39;observed&#39;, &#39;loose&#39;, &#39;tight&#39;</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;True Sparsity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1">#dummy col for plotting legend</span>
<span class="c1"># data.sort_values(&quot;coef_lasso_shift&quot;, inplace=True)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">coef_lasso_shift</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>

<span class="n">true_sparsity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mut_effects_df</span><span class="o">.</span><span class="n">shifted_site</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">aes</span><span class="p">(</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;sparsity&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_hline</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="n">true_sparsity</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;True Sparsity&quot;</span><span class="p">),</span> <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">group</span><span class="o">=</span><span class="s2">&quot;library_type&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;mut_type&quot;</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
        <span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">CBPALETTE</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">),</span>
        <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;lasso penalty coefficient (λ)&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sparsity&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/fit_sparsity.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Replicate-correlations">
<h2>Replicate correlations<a class="headerlink" href="#Replicate-correlations" title="Permalink to this heading">¶</a></h2>
<p>Another common metric to look at when evaluating models is to look at the correlation of the inferred mutational effects between the two libraries. We can do this by computing the pearson correlation coefficient between the inferred mutational effects for each mutation in the two libraries using the <code class="docutils literal notranslate"><span class="pre">multidms.ModelCollection.mut_param_dataset_correlation</span></code>
<a class="reference external" href="https://matsengrp.github.io/multidms/multidms.model_collection.html#multidms.model_collection.ModelCollection.mut_param_dataset_correlation">method</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chart</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">model_collection</span><span class="o">.</span><span class="n">mut_param_dataset_correlation</span><span class="p">(</span><span class="n">return_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>By default, the method returns a dataframe giving parameter between each unique pair of datasets, meaning it includes correlations between models fit on different measurement types. We’ll only be comparing models trained the same fitting target combination.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">data</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">lib1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">lib2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">measurement_type_1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;lib1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span>
        <span class="n">measurement_type_2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;lib2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;(measurement_type_1 == measurement_type_2) &amp; (~mut_param.str.contains(&#39;predicted_func_score&#39;))&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;measurement_type_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;shift_h2&quot;</span><span class="p">:</span> <span class="s2">&quot;shift&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;lib1&quot;</span><span class="p">,</span> <span class="s2">&quot;lib2&quot;</span><span class="p">,</span> <span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type_2&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;mut_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mut_param&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;shift&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">data</span><span class="p">[</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">coef_lasso_shift</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>

<span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">parameter_df</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mut_param&quot;</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ggplot</span><span class="p">(</span>
            <span class="n">parameter_df</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
                <span class="n">group</span><span class="o">=</span><span class="s2">&quot;measurement_type&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
            <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">),</span>
            <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
            <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Library Replicate Correlations: </span><span class="si">{</span><span class="n">parameter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;lasso penalty coefficient (λ)&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pearsonr&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/library_replicate_correlation.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Model-vs.-truth-variant-phenotypes">
<h2>Model vs. truth variant phenotypes<a class="headerlink" href="#Model-vs.-truth-variant-phenotypes" title="Permalink to this heading">¶</a></h2>
<p>Let’s take a look at how the lasso constraint affects the models’ ability to predict the true latent and observed phenotypes.</p>
<p>First, we grab the model predictions of latent and observed phenotypes for each of the datasets using <code class="docutils literal notranslate"><span class="pre">multidms.Model.get_variants_df</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variants_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">row</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_variants_df</span><span class="p">(</span><span class="n">phenotype_as_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">library</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
            <span class="n">measurement_type</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">measurement_type</span><span class="p">,</span>
            <span class="n">coef_lasso_shift</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">coef_lasso_shift</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;predicted_func_score&quot;</span><span class="p">:</span> <span class="s2">&quot;predicted_phenotype&quot;</span><span class="p">,</span>
                <span class="s2">&quot;predicted_latent&quot;</span><span class="p">:</span> <span class="s2">&quot;predicted_latent_phenotype&quot;</span><span class="p">,</span>
                <span class="s2">&quot;func_score&quot;</span> <span class="p">:</span> <span class="s2">&quot;measured_phenotype&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># add enrichments</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">predicted_enrichment</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">**</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;predicted_phenotype&#39;</span><span class="p">],</span>
            <span class="n">measured_enrichment</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">**</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;measured_phenotype&#39;</span><span class="p">],</span>
            <span class="n">fit_idx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fit_collection_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">variants_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Next, add the simulated ground truth phenotypes:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variants_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">variants_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;condition == @homolog&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">true_latent_phenotype</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">phenotype_fxn_dict</span><span class="p">[</span><span class="s2">&quot;latentPhenotype&quot;</span><span class="p">]),</span>
            <span class="n">true_observed_phenotype</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">phenotype_fxn_dict</span><span class="p">[</span><span class="s2">&quot;observedPhenotype&quot;</span><span class="p">]),</span>
            <span class="n">true_enrichment</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;aa_substitutions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">phenotype_fxn_dict</span><span class="p">[</span><span class="s2">&quot;observedEnrichment&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">homolog</span><span class="p">,</span> <span class="n">phenotype_fxn_dict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="s2">&quot;h2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">phenotype_fxn_dict_h1</span><span class="p">,</span> <span class="n">phenotype_fxn_dict_h2</span><span class="p">])</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">variants_df</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">variants_df</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># As a sanity check let&#39;s make sure the true phenotypes match the</span>
<span class="c1"># &quot;measured phenotypes&quot; (i.e. fitting targets) for the variants that were trained on ground truth targets</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
    <span class="n">variants_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;measurement_type == &#39;observed_phenotype&#39;&quot;</span><span class="p">)[</span><span class="s1">&#39;measured_phenotype&#39;</span><span class="p">],</span>
    <span class="n">variants_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;measurement_type == &#39;observed_phenotype&#39;&quot;</span><span class="p">)[</span><span class="s1">&#39;true_observed_phenotype&#39;</span><span class="p">],</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>For clarity, let’s define and arrange the columns we now have:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># unique combinations of these make up the model collection that we&#39;ve fit</span>
    <span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="c1"># replicate library,</span>
    <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="c1"># type of functional score</span>
    <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="c1"># lasso coefficient of model</span>

    <span class="c1"># variant defining columns</span>
    <span class="s2">&quot;aa_substitutions&quot;</span><span class="p">,</span> <span class="c1"># variant substitutions</span>
    <span class="s2">&quot;var_wrt_ref&quot;</span><span class="p">,</span> <span class="c1"># variant substitutions relative to reference wildtype</span>
    <span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="c1"># homolog</span>

    <span class="s2">&quot;measured_phenotype&quot;</span><span class="p">,</span> <span class="c1"># the actual target functional score for training, in multidms, this is &quot;func_score&quot;</span>
    <span class="s2">&quot;measured_enrichment&quot;</span><span class="p">,</span> <span class="c1"># 2 ** measured_func_score</span>

    <span class="s2">&quot;predicted_latent_phenotype&quot;</span><span class="p">,</span> <span class="c1"># predicted latent phenotype</span>
    <span class="s2">&quot;predicted_phenotype&quot;</span><span class="p">,</span> <span class="c1"># predicted observed phenotype - or in jesse&#39;s case, the &quot;observed phenotype&quot;</span>
    <span class="s2">&quot;predicted_enrichment&quot;</span><span class="p">,</span> <span class="c1"># predicted enrichment</span>

    <span class="s2">&quot;true_latent_phenotype&quot;</span><span class="p">,</span> <span class="c1"># true latent phenotype</span>
    <span class="s2">&quot;true_observed_phenotype&quot;</span><span class="p">,</span> <span class="c1"># true observed phenotype</span>
    <span class="s2">&quot;true_enrichment&quot;</span><span class="p">,</span> <span class="c1"># true enrichment</span>
<span class="p">]</span>
<span class="c1"># variants_df[cols].round(2).head()</span>
<br/></pre></div>
</div>
</div>
<p>Add correlation of ground truth targets / predicted phenotypes to the fit collection dataframe and plot them:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">model_variants_df</span> <span class="ow">in</span> <span class="n">variants_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;fit_idx&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">metric_fxn</span><span class="p">,</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">series_corr</span><span class="p">,</span> <span class="n">series_mae</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;corr&quot;</span><span class="p">,</span> <span class="s2">&quot;mae&quot;</span><span class="p">]):</span>
        <span class="n">fit_collection_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;variant_phenotype_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_fxn</span><span class="p">(</span>
            <span class="n">model_variants_df</span><span class="p">[</span><span class="s2">&quot;measured_phenotype&quot;</span><span class="p">],</span>
            <span class="n">model_variants_df</span><span class="p">[</span><span class="s2">&quot;predicted_phenotype&quot;</span><span class="p">]</span>
        <span class="p">)</span>

<span class="n">fit_collection_df</span><span class="p">[[</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset_name&quot;</span><span class="p">,</span> <span class="s2">&quot;variant_phenotype_corr&quot;</span><span class="p">,</span> <span class="s2">&quot;variant_phenotype_mae&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for metric in [&quot;corr&quot;, &quot;mae&quot;]:</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">fit_collection_df</span><span class="p">[[</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset_name&quot;</span><span class="p">,</span> <span class="s2">&quot;variant_phenotype_corr&quot;</span><span class="p">,</span> <span class="s2">&quot;variant_phenotype_mae&quot;</span><span class="p">]]</span>
<span class="n">metric</span> <span class="o">=</span> <span class="s2">&quot;corr&quot;</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">data</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">measurement_library</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;variant_phenotype_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="s2">&quot;measurement_library&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;variant_phenotype_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
        <span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">),</span>
        <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Predicted Vs. True Variant Phenotype&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;lasso penalty coefficient ($\lambda_</span><span class="si">{L1}</span><span class="s2">$)&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pearsonr&quot;</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;corr&quot;</span> <span class="k">else</span> <span class="s2">&quot;mean absolute error&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As expected, the lasso constraint has a negative effect on the models’ ability to predict the true latent and observed phenotypes. This is because a model with more freedom to choose parameters is likely to overfit to the training data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/model_vs_truth_variant_phenotype.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Cross-validation">
<h2>Cross validation<a class="headerlink" href="#Cross-validation" title="Permalink to this heading">¶</a></h2>
<p>Above, we saw evidence that the lasso negatively impacts the model performance on the training data. To test for overfitting, we can perform cross validation to test that the model is actually more accurate on unseen data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">measurement</span><span class="p">),</span> <span class="n">fs_df</span> <span class="ow">in</span> <span class="n">func_scores</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;homolog&quot;</span><span class="p">:</span><span class="s2">&quot;condition&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;func_score_type&quot;</span><span class="p">]):</span>

    <span class="k">if</span> <span class="s2">&quot;enrichment&quot;</span> <span class="ow">in</span> <span class="n">measurement</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fs_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">train_split</span><span class="p">,</span> <span class="n">test_split</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_frac</span><span class="p">)],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="n">train_frac</span><span class="p">):]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">library</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">measurement</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">multidms</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span>
            <span class="n">train_split</span><span class="p">,</span>
            <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span>
            <span class="n">alphabet</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">AAS_WITHSTOP_WITHGAP</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">test</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_split</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitting_params</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span>
<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fit_collection_cv</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">fit_models</span><span class="p">(</span><span class="n">fitting_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">multidms.ModelCollection.add_validation_loss</span></code> method takes in unseen data, computes model loss on that data, and appends it to the <code class="docutils literal notranslate"><span class="pre">ModelCollection.fit_models</span></code> dataframe.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="o">=</span> <span class="n">multidms</span><span class="o">.</span><span class="n">model_collection</span><span class="o">.</span><span class="n">ModelCollection</span><span class="p">(</span><span class="n">fit_collection_cv</span><span class="p">)</span>
<span class="n">mc</span><span class="o">.</span><span class="n">add_validation_loss</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span><span class="o">.</span><span class="n">fit_models</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mc</span><span class="o">.</span><span class="n">fit_models</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;loss&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">fit_models</span>

<span class="n">data</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">data</span>
    <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;total_loss_training&quot;</span><span class="p">,</span> <span class="s2">&quot;total_loss_validation&quot;</span><span class="p">],</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">lib_dataset</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="s2">&quot;lib_dataset&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;coef_lasso_shift&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;library&quot;</span>
        <span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">),</span>
        <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="n">panel_grid_major_x</span><span class="o">=</span><span class="n">element_blank</span><span class="p">(),</span>  <span class="c1"># no vertical grid lines</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;lasso penalty coefficient (λ)&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Huber loss w/o penalty&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Above we can see that indeed for both the loose and tight bottleneck datasets, the lasso constraint provides a more robust model to unseen data. We don’t however see this effect for the models trained on ground truth observed phenotypes, as there is no noise for the models to overfit to.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">csv_output_dir</span><span class="si">}</span><span class="s2">/cross_validation_loss.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Final-Selection">
<h2>Final Selection<a class="headerlink" href="#Final-Selection" title="Permalink to this heading">¶</a></h2>
<p>This analysis above provides a number of clues to inform our choice of model. With empricial data we obviously won’t have comparisons to the ground truth values, and thus the choice of a lasso penalty will laregely depend on the shift parameter sparsity, correlation of inferred mutational effects between replicate libraries, and cross validation performance. Focusing on the <em>loose bottleneck</em> training dataset (a fairly realistic level of noise that we often observe in real experiments), it seems
that a lasso penalty of <span class="math notranslate nohighlight">\(1e-4\)</span> provides a false positive rate of nearly zero (i.e. the stop codon sparsity <span class="math notranslate nohighlight">\(\approx 100\%\)</span>), a good correlation of inferred mutational effects between replicate libraries (&gt;0.95 pearsonr), and a relatively low loss on validation when compared to the other models.</p>
<p>To validate the ability to correctly infer the shape of epistasis, we’ll plot the inferred global epistasis function for each of the models, and compare it to the true global epistasis function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">variants_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coef_lasso_shift == </span><span class="si">{</span><span class="n">lasso_choice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;predicted_latent_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;predicted_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;measured_phenotype&quot;</span><span class="p">],</span> <span class="mi">2</span>
<span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span>
            <span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">facet_grid</span><span class="p">(</span><span class="s2">&quot;~measurement_type&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
            <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>
            <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;predicted_latent_phenotype&quot;</span><span class="p">:</span>
        <span class="n">p</span><span class="o">+=</span> <span class="n">geom_point</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;true_latent_phenotype&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;true_observed_phenotype&quot;</span>
            <span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">+=</span> <span class="n">geom_abline</span><span class="p">(</span>
            <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">intercept</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Plot model vs. measured (functional score) vs. ground truth enrichments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="c1"># id_vars=[&quot;measurement_type&quot;, &quot;library&quot;, &quot;condition&quot;, &quot;true_enrichment&quot;],</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;library&quot;</span><span class="p">,</span> <span class="s2">&quot;true_enrichment&quot;</span><span class="p">],</span>
            <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;predicted_enrichment&quot;</span><span class="p">,</span> <span class="s2">&quot;measured_enrichment&quot;</span><span class="p">],</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;enrichment_type&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;enrichment&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># variants_df,</span>
        <span class="n">aes</span><span class="p">(</span><span class="s2">&quot;true_enrichment&quot;</span><span class="p">,</span> <span class="s2">&quot;enrichment&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_abline</span><span class="p">(</span>
        <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">intercept</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="c1"># alpha=0.5,</span>
        <span class="c1"># size=0.5,</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_grid</span><span class="p">(</span><span class="s2">&quot;enrichment_type~measurement_type&quot;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s2">&quot;free_y&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
        <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Amazingly, the model does better at predicting true enrichments than even the counts based functional scores!</p>
<p>Finally, let’s plot the relationship between the model’s inferred shifts, and the ground truth shifts.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot correlations of true and predicted shifts</span>
<span class="n">collection_muts_df</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">collection_muts_df</span><span class="p">[</span><span class="s2">&quot;measurement_type&quot;</span><span class="p">],</span>
    <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;observed_phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;loose_bottle&quot;</span><span class="p">,</span> <span class="s2">&quot;tight_bottle&quot;</span><span class="p">],</span>
    <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;true_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;predicted_shift_h2&quot;</span><span class="p">],</span> <span class="mi">2</span>
<span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ggplot</span><span class="p">(</span><span class="n">collection_muts_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;coef_lasso_shift == </span><span class="si">{</span><span class="n">lasso_choice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span>
            <span class="n">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span>
            <span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">geom_abline</span><span class="p">(</span>
            <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">intercept</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="n">ylab</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">xlab</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">facet_grid</span><span class="p">(</span><span class="s2">&quot;library~measurement_type&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">theme_classic</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>
            <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">6.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">axis_text_x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/2020-logo-1000px-transparent.png" alt="Logo" />
    
    <h1 class="logo logo-name">multidms</h1>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=matsengrp&repo=multidms&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">multidms documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="biophysical_model.html">Biophysical model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Simulation validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="fit_delta_BA1_example.html"><code class="docutils literal notranslate"><span class="pre">multidms</span></code> usage examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="multidms.html">multidms package</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="biophysical_model.html" title="previous chapter">Biophysical model</a></li>
      <li>Next: <a href="fit_delta_BA1_example.html" title="next chapter"><code class="docutils literal notranslate"><span class="pre">multidms</span></code> usage examples</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Jared Galloway, Hugh Haddox.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 6.2.1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/simulation_validation.nblink.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>